<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสั่งพิมพ์เอกสารผลงานครูนนทพัทธ์</title>
    <link rel="icon" href="https://nonthaphathr.github.io/uploadimg/logobunthuk.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Font Sarabun สำหรับเอกสาร -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#003366', 
                        accent: '#0066CC'
                    },
                    fontFamily: { 
                        sans: ['Kanit', 'sans-serif'],
                        sarabun: ['Sarabun', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f0f8 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .gradient-text {
            background: linear-gradient(135deg, #003366 0%, #0066CC 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Checkbox Custom Style */
        .custom-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-checkbox:checked {
            background: linear-gradient(135deg, #003366, #0066CC);
            border-color: #003366;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }

        /* Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            body {
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .no-print {
                display: none !important;
            }

            .print-area {
                display: block !important;
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
            }

            .print-document {
                font-family: 'Sarabun', sans-serif !important;
                font-size: 14pt !important;
                line-height: 1.6 !important;
            }

            .print-document table {
                width: 100% !important;
                border-collapse: collapse !important;
                page-break-inside: auto !important;
            }

            .print-document tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }

            .print-document th,
            .print-document td {
                border: 1px solid #000 !important;
                padding: 8px !important;
                text-align: center !important;
            }

            .print-document th {
                background-color: #f0f0f0 !important;
                font-weight: 600 !important;
            }

            .qr-code-cell img {
                width: 60px !important;
                height: 60px !important;
            }
        }

        /* Preview Document Styles */
        .print-document {
            font-family: 'Sarabun', sans-serif;
            background: white;
            padding: 40px;
            line-height: 1.8;
        }

        .print-document table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .print-document th,
        .print-document td {
            border: 1px solid #333;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }

        .print-document th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .print-document td.description-cell {
            text-align: left;
            max-width: 250px;
        }

        .qr-code-cell img {
            width: 70px;
            height: 70px;
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Item Card */
        .item-card {
            transition: all 0.3s ease;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 51, 102, 0.15);
        }

        .item-card.selected {
            border-color: #0066CC;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
    </style>
</head>
<body class="font-sans text-gray-800 antialiased">
    
    <!-- Header -->
    <header class="glass sticky top-0 z-40 px-4 py-4 shadow-lg no-print">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="flex items-center gap-2 text-gray-500 hover:text-primary transition-colors">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span class="hidden sm:inline">กลับหน้าหลัก</span>
                </a>
            </div>
            <div class="text-center flex-1">
                <h1 class="text-xl md:text-2xl font-bold gradient-text">
                    <i class="fa-solid fa-print mr-2"></i>
                    ระบบสั่งพิมพ์เอกสาร
                </h1>
                <p class="text-xs text-gray-500">เลือกผลงานและพิมพ์เอกสารสรุป</p>
            </div>
            <div class="w-20"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-4 pb-10">
        
        <!-- Settings Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 no-print animate-fade-in">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-gear text-accent"></i>
                ตั้งค่าเอกสาร
            </h2>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fa-solid fa-heading text-accent mr-1"></i>
                        หัวข้อเอกสาร
                    </label>
                    <input 
                        type="text" 
                        id="documentTitle" 
                        value="สรุปผลงานครูนนทพัทธ์ หิรัญเรือง"
                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-all"
                        placeholder="กรอกหัวข้อเอกสาร"
                    />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fa-solid fa-database text-accent mr-1"></i>
                        เลือกประเภทข้อมูล
                    </label>
                    <select 
                        id="dataType"
                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-all"
                    >
                        <option value="projects">ผลงาน</option>
                        <option value="videos">สื่อวีดิทัศน์</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Selection Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 no-print animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-list-check text-accent"></i>
                    เลือกรายการที่ต้องการพิมพ์
                </h2>
                <div class="flex gap-2">
                    <button 
                        onclick="selectAll()"
                        class="px-4 py-2 bg-accent/10 text-accent rounded-xl text-sm font-semibold hover:bg-accent/20 transition-all"
                    >
                        <i class="fa-solid fa-check-double mr-1"></i>
                        เลือกทั้งหมด
                    </button>
                    <button 
                        onclick="deselectAll()"
                        class="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200 transition-all"
                    >
                        <i class="fa-solid fa-xmark mr-1"></i>
                        ยกเลิกทั้งหมด
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div id="loadingItems" class="text-center py-10">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-accent mb-4"></i>
                <p class="text-gray-500">กำลังโหลดข้อมูล...</p>
            </div>

            <!-- Items List -->
            <div id="itemsList" class="grid gap-3 max-h-[400px] overflow-y-auto pr-2" style="display: none;">
                <!-- Items will be loaded here -->
            </div>

            <!-- Selected Count -->
            <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                <span class="text-gray-600">
                    เลือกแล้ว: <strong id="selectedCount" class="text-accent">0</strong> รายการ
                </span>
                <button 
                    onclick="generatePreview()"
                    class="px-6 py-3 bg-gradient-to-r from-primary to-accent text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center gap-2"
                >
                    <i class="fa-solid fa-eye"></i>
                    ดูตัวอย่างเอกสาร
                </button>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="bg-white rounded-2xl shadow-lg overflow-hidden mb-6" style="display: none;">
            <div class="bg-gradient-to-r from-primary to-accent text-white p-4 flex justify-between items-center no-print">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <i class="fa-solid fa-file-lines"></i>
                    ตัวอย่างเอกสาร
                </h2>
                <button 
                    onclick="printDocument()"
                    class="px-6 py-2 bg-white text-primary rounded-xl font-semibold hover:bg-gray-100 transition-all flex items-center gap-2"
                >
                    <i class="fa-solid fa-print"></i>
                    พิมพ์เอกสาร
                </button>
            </div>
            
            <!-- Print Area -->
            <div id="printArea" class="print-area p-4">
                <div class="print-document max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
                    <!-- Document content will be generated here -->
                </div>
            </div>
        </div>

    </main>

    <script>
        // Configuration
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzszsqb63Dem1xAGnXor_xPUnNDaqGh55vCtH5Dj1-ms6oCcCOoMC72jI7pIuhhqsBS/exec";
        const LOGO_URL = "https://nonthaphathr.github.io/uploadimg/logobunthuk.png";

        let allProjects = [];
        let allVideos = [];
        let selectedItems = new Set();

        // Thai months
        const thaiMonths = [
            'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
        ];

        // Format Thai date
        function formatThaiDate(date) {
            const d = new Date(date);
            const day = d.getDate();
            const month = thaiMonths[d.getMonth()];
            const year = d.getFullYear() + 543;
            return `${day} ${month} พ.ศ. ${year}`;
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // Listen for data type change
            document.getElementById('dataType').addEventListener('change', renderItems);
        });

        // Load all data
        async function loadData() {
            try {
                // Load projects
                const projectsRes = await fetch(GAS_API_URL);
                const projectsData = await projectsRes.json();
                if (Array.isArray(projectsData)) {
                    allProjects = projectsData.reverse();
                }

                // Load videos
                const videosRes = await fetch(`${GAS_API_URL}?action=getVideos`);
                const videosData = await videosRes.json();
                if (Array.isArray(videosData)) {
                    allVideos = videosData;
                }

                renderItems();
            } catch (error) {
                console.error('Error loading data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถโหลดข้อมูลได้',
                    confirmButtonColor: '#003366'
                });
            }
        }

        // Render items based on selected type
        function renderItems() {
            const dataType = document.getElementById('dataType').value;
            const items = dataType === 'projects' ? allProjects : allVideos;
            const container = document.getElementById('itemsList');
            const loading = document.getElementById('loadingItems');

            selectedItems.clear();
            updateSelectedCount();

            if (items.length === 0) {
                loading.innerHTML = `
                    <div class="text-center py-10">
                        <i class="fa-solid fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">ไม่พบข้อมูล</p>
                    </div>
                `;
                return;
            }

            loading.style.display = 'none';
            container.style.display = 'grid';

            container.innerHTML = items.map((item, index) => `
                <div class="item-card flex items-center gap-4 p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all ${selectedItems.has(item.id) ? 'selected' : ''}"
                     onclick="toggleItem('${item.id}')" id="item-${item.id}">
                    <input 
                        type="checkbox" 
                        class="custom-checkbox flex-shrink-0"
                        ${selectedItems.has(item.id) ? 'checked' : ''}
                        onclick="event.stopPropagation(); toggleItem('${item.id}')"
                    />
                    <div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0 bg-gray-100">
                        <img 
                            src="${item.imageUrl || item.thumbnail || 'https://via.placeholder.com/64'}" 
                            alt="${item.title}"
                            class="w-full h-full object-cover"
                            onerror="this.src='https://via.placeholder.com/64/003366/ffffff?text=${index + 1}'"
                        />
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-gray-800 truncate">${item.title}</h3>
                        <p class="text-sm text-gray-500 truncate">${item.description || ''}</p>
                        <span class="inline-block mt-1 px-2 py-0.5 bg-accent/10 text-accent text-xs rounded-full">
                            ${item.category || 'ไม่ระบุหมวดหมู่'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Toggle item selection
        function toggleItem(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            
            // Update UI
            const card = document.getElementById(`item-${id}`);
            const checkbox = card.querySelector('input[type="checkbox"]');
            
            if (selectedItems.has(id)) {
                card.classList.add('selected');
                checkbox.checked = true;
            } else {
                card.classList.remove('selected');
                checkbox.checked = false;
            }
            
            updateSelectedCount();
        }

        // Select all
        function selectAll() {
            const dataType = document.getElementById('dataType').value;
            const items = dataType === 'projects' ? allProjects : allVideos;
            
            items.forEach(item => {
                selectedItems.add(item.id);
                const card = document.getElementById(`item-${item.id}`);
                if (card) {
                    card.classList.add('selected');
                    card.querySelector('input[type="checkbox"]').checked = true;
                }
            });
            
            updateSelectedCount();
        }

        // Deselect all
        function deselectAll() {
            selectedItems.forEach(id => {
                const card = document.getElementById(`item-${id}`);
                if (card) {
                    card.classList.remove('selected');
                    card.querySelector('input[type="checkbox"]').checked = false;
                }
            });
            
            selectedItems.clear();
            updateSelectedCount();
        }

        // Update selected count
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedItems.size;
        }

        // Generate preview
        function generatePreview() {
            if (selectedItems.size === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกรายการ',
                    text: 'กรุณาเลือกอย่างน้อย 1 รายการเพื่อสร้างเอกสาร',
                    confirmButtonColor: '#003366'
                });
                return;
            }

            const dataType = document.getElementById('dataType').value;
            const items = dataType === 'projects' ? allProjects : allVideos;
            const documentTitle = document.getElementById('documentTitle').value || 'สรุปผลงานครูนนทพัทธ์ หิรัญเรือง';
            const today = formatThaiDate(new Date());

            // Filter selected items
            const selectedData = items.filter(item => selectedItems.has(item.id));

            // Generate table rows
            const tableRows = selectedData.map((item, index) => `
                <tr>
                    <td style="width: 50px;">${index + 1}</td>
                    <td style="text-align: left; padding-left: 15px;">${item.title}</td>
                    <td class="description-cell" style="text-align: left; padding-left: 15px; font-size: 13px;">${item.description || '-'}</td>
                    <td class="qr-code-cell" style="width: 90px;">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=70x70&data=${encodeURIComponent(item.link)}" alt="QR Code" />
                    </td>
                </tr>
            `).join('');

            // Generate document HTML
            const documentHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <img src="${LOGO_URL}" alt="Logo" style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 15px;" />
                    <h1 style="font-size: 20px; font-weight: 700; color: #003366; margin: 0 0 10px 0;">
                        ${documentTitle}
                    </h1>
                    <p style="font-size: 14px; color: #666; margin: 0;">
                        ข้อมูล ณ วันที่ ${today}
                    </p>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">ที่</th>
                            <th>รายการ</th>
                            <th style="width: 250px;">รายละเอียด</th>
                            <th style="width: 90px;">QR Code</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>

                <div style="margin-top: 60px; text-align: center;">
                    <p style="margin: 0 0 50px 0;">ลงชื่อ......................................................</p>
                    <p style="margin: 0; font-weight: 500;">(นายนนทพัทธ์  หิรัญเรือง)</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">ครูผู้จัดทำ</p>
                </div>
            `;

            // Show preview
            document.getElementById('previewSection').style.display = 'block';
            document.querySelector('#printArea .print-document').innerHTML = documentHTML;

            // Scroll to preview
            document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Print document
        function printDocument() {
            window.print();
        }
    </script>

</body>
</html>
