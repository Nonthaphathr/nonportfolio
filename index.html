<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบบันทึกผลงานครูนนทพัทธ์</title>
    <link rel="icon" href="https://nonthaphathr.github.io/uploadimg/logobunthuk.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#003366', 
                        gold: '#D4AF37', 
                        secondary: '#f3f4f6',
                        accent: '#0066CC'
                    },
                    fontFamily: { sans: ['Kanit', 'sans-serif'] },
                    boxShadow: { 
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
                        'glow': '0 0 20px rgba(0, 102, 204, 0.3)',
                        'card': '0 10px 40px -10px rgba(0, 0, 0, 0.15)'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f0f8 100%);
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh;
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px) saturate(180%); 
            -webkit-backdrop-filter: blur(20px) saturate(180%); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #003366 0%, #0066CC 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Animations */
        @keyframes slideUp { 
            from { transform: translateY(30px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        @keyframes scaleIn { 
            from { transform: scale(0.9); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes glow-pulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(0, 102, 204, 0.4),
                           0 0 40px rgba(0, 102, 204, 0.2);
            }
            50% { 
                box-shadow: 0 0 30px rgba(0, 102, 204, 0.6),
                           0 0 60px rgba(0, 102, 204, 0.3);
            }
        }
        
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo-glow {
            animation: glow-pulse 3s ease-in-out infinite;
        }
        
        .animate-count-up {
            animation: countUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px -10px rgba(0, 51, 102, 0.2);
        }

        
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Card Hover Effect */
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px -10px rgba(0, 51, 102, 0.25);
        }
        
        .card-hover:active {
            transform: translateY(-4px) scale(1.01);
        }
        
        /* Image Zoom Effect */
        .image-zoom {
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover .image-zoom {
            transform: scale(1.1);
        }
        
        /* Button Effects */
        .btn-primary {
            background: linear-gradient(135deg, #003366 0%, #0066CC 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            box-shadow: 0 8px 25px -5px rgba(0, 51, 102, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Category Pills */
        .category-pill {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .category-pill:hover {
            transform: translateY(-2px);
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* Search Box Enhancement */
        .search-box {
            transition: all 0.3s ease;
        }
        
        .search-box:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 102, 204, 0.2);
        }
        
        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple:active::after {
            width: 300px;
            height: 300px;
        }
        
        /* Masonry Grid for Infographic */
        .masonry-grid {
            column-count: 1;
            column-gap: 1.5rem;
        }
        @media (min-width: 640px) {
            .masonry-grid { column-count: 2; }
        }
        @media (min-width: 1024px) {
            .masonry-grid { column-count: 3; }
        }
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1.5rem;
            display: inline-block;
            width: 100%;
        }
        
        /* iOS Safe Area */
        @supports (padding: max(0px)) {
            .safe-top { padding-top: max(1rem, env(safe-area-inset-top)); }
            .safe-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        }
        
        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="font-sans text-gray-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ตั้งค่า URL ของคุณที่นี่ ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzszsqb63Dem1xAGnXor_xPUnNDaqGh55vCtH5Dj1-ms6oCcCOoMC72jI7pIuhhqsBS/exec";
        const LOGO_URL = "https://nonthaphathr.github.io/uploadimg/logobunthuk.png";
        const ADMIN_PIN = "1234";
        const CATEGORIES = ["ทั้งหมด", "Web Application", "AI & Data", "สื่อการสอน", "อื่นๆ"];
        const INFOGRAPHIC_FOLDER_ID = "1PqKi9ScERr0fGvgFk4Njq7h02uht2K7T";

        function Toast({ message, onClose }) {
            useEffect(() => { 
                const timer = setTimeout(onClose, 3000); 
                return () => clearTimeout(timer); 
            }, [onClose]);
            
            return (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-50 animate-slide-up">
                    <div className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 backdrop-blur-sm">
                        <div className="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center animate-scale-in">
                            <i className="fa-solid fa-check text-sm"></i>
                        </div>
                        <span className="font-medium text-sm">{message}</span>
                    </div>
                </div>
            );
        }

        function CountUpNumber({ end, duration = 2000 }) {
            const [count, setCount] = useState(0);

            useEffect(() => {
                let startTime;
                const animate = (currentTime) => {
                    if (!startTime) startTime = currentTime;
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    setCount(Math.floor(progress * end));
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                requestAnimationFrame(animate);
            }, [end, duration]);

            return <span className="animate-count-up">{count.toLocaleString()}</span>;
        }

        function StatsSection({ projects, visitors, activeTab, infographics }) {
            const stats = activeTab === 'projects' ? [
                {
                    icon: 'fa-solid fa-folder-open',
                    label: 'ผลงานทั้งหมด',
                    value: projects.length,
                    color: 'from-blue-500 to-indigo-600',
                    bgColor: 'from-blue-50 to-indigo-50'
                },
                {
                    icon: 'fa-solid fa-eye',
                    label: 'ผู้เข้าชม',
                    value: visitors,
                    color: 'from-emerald-500 to-teal-600',
                    bgColor: 'from-emerald-50 to-teal-50'
                },
                {
                    icon: 'fa-solid fa-layer-group',
                    label: 'หมวดหมู่',
                    value: CATEGORIES.length - 1,
                    color: 'from-purple-500 to-pink-600',
                    bgColor: 'from-purple-50 to-pink-50'
                },
                {
                    icon: 'fa-solid fa-calendar-check',
                    label: 'อัพเดทล่าสุด',
                    value: projects.length > 0 && projects[0].timestamp ? new Date(projects[0].timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) : '-',
                    color: 'from-orange-500 to-red-600',
                    bgColor: 'from-orange-50 to-red-50',
                    isDate: true
                }
            ] : [
                {
                    icon: 'fa-solid fa-images',
                    label: 'Infographic ทั้งหมด',
                    value: infographics.length,
                    color: 'from-pink-500 to-rose-600',
                    bgColor: 'from-pink-50 to-rose-50'
                },
                {
                    icon: 'fa-solid fa-eye',
                    label: 'ผู้เข้าชม',
                    value: visitors,
                    color: 'from-emerald-500 to-teal-600',
                    bgColor: 'from-emerald-50 to-teal-50'
                },
                {
                    icon: 'fa-solid fa-download',
                    label: 'พร้อมดาวน์โหลด',
                    value: infographics.length,
                    color: 'from-blue-500 to-cyan-600',
                    bgColor: 'from-blue-50 to-cyan-50'
                },
                {
                    icon: 'fa-solid fa-calendar-check',
                    label: 'อัพเดทล่าสุด',
                    value: infographics.length > 0 && infographics[0].timestamp ? new Date(infographics[0].timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) : '-',
                    color: 'from-orange-500 to-red-600',
                    bgColor: 'from-orange-50 to-red-50',
                    isDate: true
                }
            ];

            return (
                <div className="px-4 max-w-4xl mx-auto mb-6">
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        {stats.map((stat, index) => (
                            <div 
                                key={index}
                                className="stat-card rounded-2xl p-4 md:p-5 shadow-md border border-gray-100 animate-slide-up"
                                style={{ animationDelay: `${index * 0.1}s` }}
                            >
                                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${stat.bgColor} flex items-center justify-center mb-3`}>
                                    <i className={`${stat.icon} text-xl bg-gradient-to-br ${stat.color} bg-clip-text text-transparent`}></i>
                                </div>
                                <div className="text-2xl md:text-3xl font-bold gradient-text mb-1">
                                    {stat.isDate ? stat.value : <CountUpNumber end={stat.value} />}
                                </div>
                                <div className="text-xs md:text-sm text-gray-500 font-medium">{stat.label}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function QRModal({ link, title, onClose }) {
            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4 modal-backdrop" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl modal-content" onClick={e => e.stopPropagation()}>
                        <div className="mb-6">
                            <div className="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center animate-scale-in">
                                <i className="fa-solid fa-qrcode text-white text-2xl"></i>
                            </div>
                            <h3 className="text-xl font-bold gradient-text mb-2">สแกนเพื่อเข้าชม</h3>
                            <p className="text-sm text-gray-500 line-clamp-2 px-4">{title}</p>
                        </div>
                        
                        <div className="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-2xl shadow-inner inline-block mb-6">
                            <img 
                                src={`https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(link)}`} 
                                className="w-64 h-64 object-contain rounded-xl" 
                                alt="QR Code"
                            />
                        </div>
                        
                        <button 
                            onClick={onClose} 
                            className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium transition-all active:scale-95"
                        >
                            ปิดหน้าต่าง
                        </button>
                    </div>
                </div>
            );
        }

        function Header({ onAddClick, activeTab, onTabChange }) {
            return (
                <header className="glass sticky top-0 z-40 px-4 py-4 shadow-lg safe-top">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center space-x-4">
                                <div className="relative">
                                    <img 
                                        src={LOGO_URL} 
                                        alt="Logo" 
                                        className="h-12 w-12 md:h-14 md:w-14 rounded-2xl border-2 border-white shadow-lg object-cover animate-scale-in logo-glow" 
                                    />
                                </div>
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold gradient-text leading-tight">
                                        ผลงานครูนนทพัทธ์
                                    </h1>
                                    <p className="text-xs text-gray-500 font-medium">e-Portfolio System</p>
                                </div>
                            </div>
                            <button 
                                onClick={onAddClick} 
                                className="btn-primary ripple text-white w-12 h-12 rounded-2xl shadow-lg flex items-center justify-center active:scale-95"
                            >
                                <i className="fa-solid fa-plus text-base"></i>
                            </button>
                        </div>
                        
                        {/* Tab Navigation */}
                        <div className="flex gap-3">
                            <button 
                                onClick={() => onTabChange('projects')}
                                className={`flex-1 py-3 rounded-xl font-semibold text-sm transition-all ${
                                    activeTab === 'projects' 
                                        ? 'bg-gradient-to-r from-primary to-accent text-white shadow-lg scale-105' 
                                        : 'bg-white/70 text-gray-600 hover:bg-white hover:text-accent'
                                }`}
                            >
                                <i className="fa-solid fa-folder-open mr-2"></i>
                                ผลงาน
                            </button>
                            <button 
                                onClick={() => onTabChange('infographic')}
                                className={`flex-1 py-3 rounded-xl font-semibold text-sm transition-all ${
                                    activeTab === 'infographic' 
                                        ? 'bg-gradient-to-r from-primary to-accent text-white shadow-lg scale-105' 
                                        : 'bg-white/70 text-gray-600 hover:bg-white hover:text-accent'
                                }`}
                            >
                                <i className="fa-solid fa-image mr-2"></i>
                                Infographic
                            </button>
                        </div>
                    </div>
                </header>
            );
        }

        function SearchBox({ value, onChange }) {
            return (
                <div className="px-4 max-w-4xl mx-auto mt-6 mb-4">
                    <div className="relative search-box bg-white rounded-2xl shadow-md">
                        <i className="fa-solid fa-search absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                        <input 
                            type="text" 
                            value={value}
                            onChange={(e) => onChange(e.target.value)}
                            placeholder="ค้นหาชื่อผลงาน, รายละเอียด..." 
                            className="w-full pl-12 pr-5 py-4 rounded-2xl border-none focus:ring-2 focus:ring-accent bg-transparent outline-none transition-all placeholder-gray-400 text-sm md:text-base"
                        />
                        {value && (
                            <button
                                onClick={() => onChange('')}
                                className="absolute right-4 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition-all"
                            >
                                <i className="fa-solid fa-times text-xs text-gray-600"></i>
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function FilterBar({ selected, onSelect }) {
            return (
                <div className="sticky top-[164px] z-30 glass py-4 border-b border-gray-200/50 shadow-sm">
                    <div className="flex overflow-x-auto hide-scroll gap-3 px-4 max-w-4xl mx-auto snap-x">
                        {CATEGORIES.map(cat => (
                            <button 
                                key={cat} 
                                onClick={() => onSelect(cat)} 
                                className={`category-pill whitespace-nowrap px-5 py-2.5 rounded-xl text-sm font-semibold transition-all snap-start ${
                                    selected === cat 
                                        ? 'bg-gradient-to-r from-primary to-accent text-white shadow-lg scale-105' 
                                        : 'bg-white text-gray-600 border-2 border-gray-200 hover:border-accent hover:text-accent'
                                }`}
                            >
                                {cat}
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        function ProjectCard({ project, onOpen, onCopy, onQR, onEdit, onDelete }) {
            return (
                <div className="bg-white rounded-3xl shadow-card overflow-hidden flex flex-col h-full card-hover relative group">
                    <div className="absolute top-3 right-3 z-10 flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-all duration-300">
                        <button 
                            onClick={(e) => { e.stopPropagation(); onEdit(project); }} 
                            className="bg-white/95 backdrop-blur p-2.5 rounded-xl shadow-lg text-blue-600 hover:text-blue-800 hover:scale-110 transition-all"
                        >
                            <i className="fa-solid fa-pen text-xs"></i>
                        </button>
                        <button 
                            onClick={(e) => { e.stopPropagation(); onDelete(project); }} 
                            className="bg-white/95 backdrop-blur p-2.5 rounded-xl shadow-lg text-red-500 hover:text-red-700 hover:scale-110 transition-all"
                        >
                            <i className="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>

                    <div className="relative h-48 overflow-hidden cursor-pointer bg-gradient-to-br from-gray-100 to-gray-200" onClick={() => onOpen(project)}>
                        <img 
                            src={project.imageUrl} 
                            alt={project.title} 
                            className="w-full h-full object-cover image-zoom" 
                            loading="lazy" 
                            onError={(e) => e.target.src = 'https://via.placeholder.com/400x300?text=No+Image'} 
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <span className="absolute top-3 left-3 bg-white/90 backdrop-blur text-gray-800 text-xs font-semibold px-3 py-1.5 rounded-lg shadow-md">
                            {project.category}
                        </span>
                    </div>
                    
                    <div className="p-5 flex-1 flex flex-col cursor-pointer" onClick={() => onOpen(project)}>
                        <h3 className="font-bold text-gray-800 text-lg leading-tight mb-2 line-clamp-2 group-hover:text-accent transition-colors">
                            {project.title}
                        </h3>
                        <p className="text-gray-600 text-sm line-clamp-3 flex-1 leading-relaxed">
                            {project.description}
                        </p>
                        <div className="text-xs text-gray-400 mt-4 flex items-center gap-2">
                            <i className="fa-regular fa-clock"></i>
                            <span>{new Date(project.timestamp).toLocaleDateString('th-TH', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            })}</span>
                        </div>
                    </div>
                    
                    <div className="border-t border-gray-100 px-5 py-4 flex items-center justify-between bg-gradient-to-br from-gray-50 to-white">
                        <a 
                            href={project.link} 
                            target="_blank" 
                            className="flex items-center gap-2 text-accent text-sm font-bold hover:gap-3 transition-all"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <i className="fa-solid fa-arrow-up-right-from-square"></i>
                            <span>เปิดงาน</span>
                        </a>
                        <div className="flex gap-2">
                            <button 
                                onClick={(e) => { e.stopPropagation(); onQR(project); }} 
                                className="w-9 h-9 rounded-xl bg-white border-2 border-gray-200 flex items-center justify-center text-gray-600 hover:text-accent hover:border-accent hover:scale-110 transition-all"
                            >
                                <i className="fa-solid fa-qrcode text-sm"></i>
                            </button>
                            <button 
                                onClick={(e) => { e.stopPropagation(); onCopy(project.link); }} 
                                className="w-9 h-9 rounded-xl bg-white border-2 border-gray-200 flex items-center justify-center text-gray-600 hover:text-accent hover:border-accent hover:scale-110 transition-all"
                            >
                                <i className="fa-regular fa-copy text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function InfographicCard({ infographic, onView, onDownload, onEdit, onDelete }) {
            return (
                <div className="masonry-item">
                    <div className="bg-white rounded-3xl shadow-card overflow-hidden card-hover relative group animate-fade-in">
                        <div className="absolute top-3 right-3 z-10 flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-all duration-300">
                            <button 
                                onClick={(e) => { e.stopPropagation(); onEdit(infographic); }} 
                                className="bg-white/95 backdrop-blur p-2.5 rounded-xl shadow-lg text-blue-600 hover:text-blue-800 hover:scale-110 transition-all"
                            >
                                <i className="fa-solid fa-pen text-xs"></i>
                            </button>
                            <button 
                                onClick={(e) => { e.stopPropagation(); onDelete(infographic); }} 
                                className="bg-white/95 backdrop-blur p-2.5 rounded-xl shadow-lg text-red-500 hover:text-red-700 hover:scale-110 transition-all"
                            >
                                <i className="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>

                        <div className="relative cursor-pointer overflow-hidden" onClick={() => onView(infographic)}>
                            <img 
                                src={infographic.imageUrl} 
                                alt={infographic.title} 
                                className="w-full h-auto object-cover image-zoom" 
                                loading="lazy"
                                onError={(e) => {
                                    console.error('Image load error:', infographic.imageUrl);
                                    e.target.src = 'https://via.placeholder.com/400x600/e8f0f8/003366?text=รูปภาพไม่สามารถโหลดได้';
                                }}
                            />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        </div>

                        <div className="p-5">
                            <h3 className="font-bold text-gray-800 text-base leading-tight mb-3 line-clamp-2">
                                {infographic.title}
                            </h3>
                            <div className="text-xs text-gray-400 mb-4 flex items-center gap-2">
                                <i className="fa-regular fa-clock"></i>
                                <span>{infographic.timestamp ? new Date(infographic.timestamp).toLocaleDateString('th-TH', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                }) : 'ไม่ระบุวันที่'}</span>
                            </div>
                            <button 
                                onClick={(e) => { e.stopPropagation(); onDownload(infographic); }}
                                className="w-full btn-primary ripple text-white py-3 rounded-xl font-semibold text-sm hover:shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2"
                            >
                                <i className="fa-solid fa-download"></i>
                                ดาวน์โหลดภาพ
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function InfographicViewer({ infographic, onClose, onDownload }) {
            if (!infographic) return null;

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 modal-backdrop" onClick={onClose}>
                    <div className="w-full max-w-4xl max-h-[90vh] flex flex-col modal-content" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 px-2">
                            <h3 className="text-white font-bold text-lg md:text-xl truncate pr-4 flex-1">
                                {infographic.title}
                            </h3>
                            <button 
                                onClick={onClose} 
                                className="bg-white/10 hover:bg-white/20 p-3 rounded-2xl transition-all flex-shrink-0"
                            >
                                <i className="fa-solid fa-xmark text-white text-xl"></i>
                            </button>
                        </div>
                        
                        <div className="flex-1 overflow-auto bg-white/5 rounded-3xl p-4 backdrop-blur hide-scroll">
                            <img 
                                src={infographic.imageUrl} 
                                alt={infographic.title}
                                className="w-full h-auto object-contain rounded-2xl"
                                onError={(e) => {
                                    console.error('Image load error in viewer:', infographic.imageUrl);
                                    e.target.src = 'https://via.placeholder.com/800x1200/e8f0f8/003366?text=รูปภาพไม่สามารถโหลดได้';
                                }}
                            />
                        </div>

                        <div className="mt-4 flex gap-3">
                            <button 
                                onClick={() => onDownload(infographic)}
                                className="flex-1 bg-white text-primary py-4 rounded-2xl font-bold hover:bg-gray-100 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg"
                            >
                                <i className="fa-solid fa-download"></i>
                                ดาวน์โหลดภาพ
                            </button>
                            <button 
                                onClick={() => {
                                    const match = infographic.imageUrl.match(/[?&]id=([^&]+)/);
                                    if (match && match[1]) {
                                        window.open(`https://drive.google.com/file/d/${match[1]}/view`, '_blank');
                                    } else {
                                        window.open(infographic.imageUrl, '_blank');
                                    }
                                }}
                                className="bg-white/20 text-white py-4 px-6 rounded-2xl font-bold hover:bg-white/30 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg"
                            >
                                <i className="fa-brands fa-google-drive"></i>
                                <span className="hidden md:inline">เปิดใน Drive</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function InfographicFormModal({ isOpen, onClose, refreshData, initialData = null }) {
            const [loading, setLoading] = useState(false);
            const formRef = useRef(null);
            const isEditMode = !!initialData;

            const toBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                const formData = new FormData(formRef.current);
                const file = formData.get('imageFile');

                try {
                    let payload = {
                        action: isEditMode ? 'updateInfographic' : 'createInfographic',
                        id: isEditMode ? initialData.id : null,
                        title: formData.get('title'),
                        folderId: INFOGRAPHIC_FOLDER_ID,
                        oldImageUrl: isEditMode ? initialData.imageUrl : ""
                    };

                    if (file && file.size > 0) {
                        console.log('Uploading file:', file.name, 'Size:', file.size);
                        const base64Image = await toBase64(file);
                        payload.imageBase64 = base64Image.split(',')[1];
                        payload.imageType = file.type;
                    } else if (!isEditMode) {
                        alert("กรุณาเลือกไฟล์รูปภาพ");
                        setLoading(false);
                        return;
                    }

                    console.log('Sending payload to API...');
                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    alert(isEditMode ? "แก้ไขข้อมูลสำเร็จ!" : "บันทึกข้อมูลสำเร็จ!");
                    onClose();
                    setTimeout(refreshData, 2000);
                } catch (error) {
                    console.error("Submit error:", error);
                    alert("เกิดข้อผิดพลาด: " + error.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end md:items-center justify-center sm:p-4 modal-backdrop">
                    <div className="bg-white w-full max-w-lg rounded-t-3xl md:rounded-3xl p-8 max-h-[90vh] overflow-y-auto modal-content shadow-2xl safe-bottom">
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h2 className="text-2xl font-bold gradient-text">
                                    {isEditMode ? 'แก้ไข Infographic' : 'เพิ่ม Infographic ใหม่'}
                                </h2>
                                <p className="text-sm text-gray-500 mt-1">อัปโหลดสื่อการสอนของคุณ</p>
                            </div>
                            <button 
                                onClick={onClose} 
                                className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 w-10 h-10 rounded-xl flex items-center justify-center transition-all"
                            >
                                <i className="fa-solid fa-xmark text-2xl"></i>
                            </button>
                        </div>
                        
                        <form ref={formRef} onSubmit={handleSubmit} className="space-y-5">
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i className="fa-solid fa-heading text-accent"></i>
                                    ชื่อ Infographic
                                </label>
                                <input 
                                    type="text" 
                                    name="title" 
                                    defaultValue={isEditMode ? initialData.title : ''} 
                                    required 
                                    className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-all" 
                                    placeholder="เช่น แผนภูมิวงจรชีวิตผีเสื้อ"
                                />
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i className="fa-solid fa-image text-accent"></i>
                                    ไฟล์รูปภาพ
                                    {isEditMode && <span className="text-xs text-gray-400 font-normal">(ไม่ต้องเลือกถ้าไม่เปลี่ยน)</span>}
                                </label>
                                <div className="relative">
                                    <input 
                                        type="file" 
                                        name="imageFile" 
                                        accept="image/*" 
                                        className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:border-accent transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-accent file:text-white hover:file:bg-blue-700 cursor-pointer" 
                                    />
                                </div>
                                <p className="text-xs text-gray-500">รองรับไฟล์: JPG, PNG, WebP (แนะนำขนาดไม่เกิน 5MB)</p>
                            </div>
                            
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full btn-primary ripple text-white font-bold py-4 rounded-xl shadow-lg mt-6 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                            >
                                {loading ? (
                                    <>
                                        <i className="fa-solid fa-spinner fa-spin"></i>
                                        <span>กำลังบันทึก...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-save"></i>
                                        <span>บันทึกข้อมูล</span>
                                    </>
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function ProjectFormModal({ isOpen, onClose, refreshData, initialData = null }) {
            const [loading, setLoading] = useState(false);
            const formRef = useRef(null);
            const isEditMode = !!initialData;

            const toBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader(); 
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result); 
                reader.onerror = error => reject(error);
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                const formData = new FormData(formRef.current);
                const file = formData.get('imageFile');

                try {
                    let payload = {
                        action: isEditMode ? 'update' : 'create',
                        id: isEditMode ? initialData.id : null,
                        title: formData.get('title'),
                        description: formData.get('description'),
                        category: formData.get('category'),
                        link: formData.get('link'),
                        oldImageUrl: isEditMode ? initialData.imageUrl : ""
                    };

                    if (file && file.size > 0) {
                        const base64Image = await toBase64(file);
                        payload.imageBase64 = base64Image.split(',')[1];
                        payload.imageType = file.type;
                    }

                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    alert(isEditMode ? "แก้ไขข้อมูลสำเร็จ!" : "บันทึกข้อมูลสำเร็จ!");
                    onClose();
                    setTimeout(refreshData, 2000);
                } catch (error) {
                    alert("เกิดข้อผิดพลาด: " + error.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end md:items-center justify-center sm:p-4 modal-backdrop">
                    <div className="bg-white w-full max-w-lg rounded-t-3xl md:rounded-3xl p-8 max-h-[90vh] overflow-y-auto modal-content shadow-2xl safe-bottom">
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h2 className="text-2xl font-bold gradient-text">
                                    {isEditMode ? 'แก้ไขข้อมูล' : 'เพิ่มผลงานใหม่'}
                                </h2>
                                <p className="text-sm text-gray-500 mt-1">กรอกข้อมูลให้ครบถ้วน</p>
                            </div>
                            <button 
                                onClick={onClose} 
                                className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 w-10 h-10 rounded-xl flex items-center justify-center transition-all"
                            >
                                <i className="fa-solid fa-xmark text-2xl"></i>
                            </button>
                        </div>
                        
                        <form ref={formRef} onSubmit={handleSubmit} className="space-y-5">
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i className="fa-solid fa-heading text-accent"></i>
                                    ชื่อผลงาน
                                </label>
                                <input 
                                    type="text" 
                                    name="title" 
                                    defaultValue={isEditMode ? initialData.title : ''} 
                                    required 
                                    className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-all" 
                                    placeholder="เช่น ระบบจัดการห้องสมุด"
                                />
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i className="fa-solid fa-tag text-accent"></i>
                                    หมวดหมู่
                                </label>
                                <select 
                                    name="category" 
                                    defaultValue={isEditMode ? initialData.category : CATEGORIES[1]} 
                                    className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-all"
                                >
                                    {CATEGORIES.filter(c => c !== 'ทั้งหมด').map(c => 
                                        <option key={c} value={c}>{c}</option>
                                    )}
                                </select>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i className="fa-solid fa-align-left text-accent"></i>
                                    คำอธิบาย
                                </label>
                                <textarea 
                                    name="description" 
                                    rows="4" 
                                    defaultValue={isEditMode ? initialData.description : ''} 
                                    required 
                                    className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-all resize-none" 
                                    placeholder="อธิบายรายละเอียดของผลงาน..."
                                ></textarea>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i className="fa-solid fa-link text-accent"></i>
                                    ลิงก์ (URL)
                                </label>
                                <input 
                                    type="url" 
                                    name="link" 
                                    defaultValue={isEditMode ? initialData.link : ''} 
                                    required 
                                    className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-all" 
                                    placeholder="https://example.com" 
                                />
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i className="fa-solid fa-image text-accent"></i>
                                    รูปภาพปก 
                                    {isEditMode && <span className="text-xs text-gray-400 font-normal">(ไม่ต้องเลือกถ้าไม่เปลี่ยน)</span>}
                                </label>
                                <div className="relative">
                                    <input 
                                        type="file" 
                                        name="imageFile" 
                                        accept="image/*" 
                                        className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:border-accent transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-accent file:text-white hover:file:bg-blue-700 cursor-pointer" 
                                    />
                                </div>
                            </div>
                            
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full btn-primary ripple text-white font-bold py-4 rounded-xl shadow-lg mt-6 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                            >
                                {loading ? (
                                    <>
                                        <i className="fa-solid fa-spinner fa-spin"></i>
                                        <span>กำลังบันทึก...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-save"></i>
                                        <span>บันทึกข้อมูล</span>
                                    </>
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function SkeletonCard() {
            return (
                <div className="bg-white rounded-3xl shadow-card overflow-hidden animate-pulse">
                    <div className="skeleton h-48"></div>
                    <div className="p-5 space-y-3">
                        <div className="skeleton h-5 w-3/4 rounded"></div>
                        <div className="skeleton h-4 w-full rounded"></div>
                        <div className="skeleton h-4 w-2/3 rounded"></div>
                        <div className="skeleton h-3 w-1/3 rounded mt-4"></div>
                    </div>
                    <div className="border-t border-gray-100 px-5 py-4 flex justify-between">
                        <div className="skeleton h-8 w-24 rounded-lg"></div>
                        <div className="flex gap-2">
                            <div className="skeleton h-9 w-9 rounded-xl"></div>
                            <div className="skeleton h-9 w-9 rounded-xl"></div>
                        </div>
                    </div>
                </div>
            );
        }

        function InfographicSkeleton() {
            return (
                <div className="masonry-item">
                    <div className="bg-white rounded-3xl shadow-card overflow-hidden animate-pulse">
                        <div className="skeleton h-64"></div>
                        <div className="p-5 space-y-3">
                            <div className="skeleton h-5 w-3/4 rounded"></div>
                            <div className="skeleton h-3 w-1/2 rounded"></div>
                            <div className="skeleton h-10 w-full rounded-xl mt-4"></div>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [activeTab, setActiveTab] = useState('projects');
            const [projects, setProjects] = useState([]);
            const [infographics, setInfographics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedCategory, setSelectedCategory] = useState("ทั้งหมด");
            const [searchTerm, setSearchTerm] = useState("");
            const [visitors, setVisitors] = useState(0);
            
            const [viewProject, setViewProject] = useState(null);
            const [viewInfographic, setViewInfographic] = useState(null);
            const [formModalOpen, setFormModalOpen] = useState(false);
            const [infographicFormOpen, setInfographicFormOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [editingInfographic, setEditingInfographic] = useState(null);
            const [toastMsg, setToastMsg] = useState(null);
            const [qrData, setQrData] = useState(null);

            const fetchProjects = async () => {
                setLoading(true);
                try {
                    const res = await fetch(GAS_API_URL);
                    const data = await res.json();
                    if (Array.isArray(data)) setProjects(data.reverse());
                } catch (e) { 
                    console.error(e); 
                } finally { 
                    setLoading(false); 
                }
            };

            const fetchInfographics = async () => {
                setLoading(true);
                try {
                    console.log('Fetching infographics from:', `${GAS_API_URL}?action=getInfographics&folderId=${INFOGRAPHIC_FOLDER_ID}`);
                    const res = await fetch(`${GAS_API_URL}?action=getInfographics&folderId=${INFOGRAPHIC_FOLDER_ID}`);
                    const data = await res.json();
                    console.log('Infographics data received:', data);
                    if (Array.isArray(data)) {
                        setInfographics(data.reverse());
                        console.log('Infographics set:', data);
                    } else {
                        console.error('Data is not an array:', data);
                    }
                } catch (e) { 
                    console.error('Error fetching infographics:', e); 
                } finally { 
                    setLoading(false); 
                }
            };

            useEffect(() => { 
                if (activeTab === 'projects') {
                    fetchProjects(); 
                } else {
                    fetchInfographics();
                }
            }, [activeTab]);

            useEffect(() => {
                // Track visitors using API
                const VISITED_KEY = 'portfolio_has_visited';
                const hasVisited = localStorage.getItem(VISITED_KEY);
                
                const fetchAndTrackVisitors = async () => {
                    try {
                        if (!hasVisited) {
                            // New visitor - track it
                            localStorage.setItem(VISITED_KEY, 'true');
                            const trackRes = await fetch(`${GAS_API_URL}?action=trackVisitor`);
                            const trackData = await trackRes.json();
                            if (trackData.visitors) {
                                setVisitors(trackData.visitors);
                            }
                        } else {
                            // Returning visitor - just get count
                            const statsRes = await fetch(`${GAS_API_URL}?action=getStats`);
                            const statsData = await statsRes.json();
                            if (statsData.visitors !== undefined) {
                                setVisitors(statsData.visitors);
                            }
                        }
                    } catch (error) {
                        console.error('Error tracking visitors:', error);
                        // Fallback to 0 if error
                        setVisitors(0);
                    }
                };
                
                fetchAndTrackVisitors();
            }, []);

            const checkAdmin = () => {
                const pin = prompt("กรุณากรอกรหัส Admin เพื่อดำเนินการ:");
                return pin === ADMIN_PIN;
            };

            const handleDelete = async (project) => {
                if (!checkAdmin()) return alert("รหัสผ่านไม่ถูกต้อง");
                if (!confirm(`ต้องการลบ "${project.title}" ใช่หรือไม่?`)) return;

                setLoading(true);
                try {
                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete', id: project.id })
                    });
                    alert("ลบข้อมูลสำเร็จ!");
                    setTimeout(fetchProjects, 1000);
                } catch (e) { 
                    alert("ลบไม่สำเร็จ: " + e.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const handleDeleteInfographic = async (infographic) => {
                if (!checkAdmin()) return alert("รหัสผ่านไม่ถูกต้อง");
                if (!confirm(`ต้องการลบ "${infographic.title}" ใช่หรือไม่?`)) return;

                setLoading(true);
                try {
                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'deleteInfographic', id: infographic.id })
                    });
                    alert("ลบข้อมูลสำเร็จ!");
                    setTimeout(fetchInfographics, 1000);
                } catch (e) { 
                    alert("ลบไม่สำเร็จ: " + e.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const handleEditStart = (project) => {
                if (!checkAdmin()) return alert("รหัสผ่านไม่ถูกต้อง");
                setEditingProject(project);
                setFormModalOpen(true);
            };

            const handleEditInfographic = (infographic) => {
                if (!checkAdmin()) return alert("รหัสผ่านไม่ถูกต้อง");
                setEditingInfographic(infographic);
                setInfographicFormOpen(true);
            };

            const handleAddStart = () => {
                if (activeTab === 'projects') {
                    setEditingProject(null);
                    setFormModalOpen(true);
                } else {
                    setEditingInfographic(null);
                    setInfographicFormOpen(true);
                }
            };

            const handleDownloadInfographic = async (infographic) => {
                try {
                    // ดึง file ID จาก thumbnail URL
                    const match = infographic.imageUrl.match(/[?&]id=([^&]+)/);
                    if (!match || !match[1]) {
                        throw new Error('Cannot extract file ID');
                    }
                    
                    const fileId = match[1];
                    const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                    
                    // เปิดในแท็บใหม่เพื่อดาวน์โหลด
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = `${infographic.title}.jpg`;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setToastMsg("กำลังดาวน์โหลด...");
                } catch (error) {
                    console.error("Download error:", error);
                    alert("ไม่สามารถดาวน์โหลดได้ กรุณาคลิกปุ่ม 'เปิดใน Drive' แทน");
                }
            };

            const filtered = projects.filter(p => {
                const matchCategory = selectedCategory === "ทั้งหมด" || p.category === selectedCategory;
                const matchSearch = p.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                    p.description.toLowerCase().includes(searchTerm.toLowerCase());
                return matchCategory && matchSearch;
            });

            const filteredInfographics = infographics.filter(i => 
                i.title.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen pb-10 safe-bottom">
                    <Header 
                        onAddClick={handleAddStart} 
                        activeTab={activeTab}
                        onTabChange={setActiveTab}
                    />
                    
                    <main className="max-w-4xl mx-auto">
                        {activeTab === 'projects' ? (
                            <>
                                <div className="px-4 pt-8 pb-4">
                                    <h2 className="text-3xl md:text-4xl font-bold gradient-text mb-2">
                                        แฟ้มผลงาน
                                    </h2>
                                    <p className="text-gray-500 text-sm md:text-base flex items-center gap-2">
                                        <i className="fa-solid fa-sparkles text-gold"></i>
                                        รวมนวัตกรรมและเทคโนโลยีทางการศึกษา
                                    </p>
                                </div>
                                
                                <SearchBox value={searchTerm} onChange={setSearchTerm} />
                                <StatsSection projects={projects} visitors={visitors} activeTab={activeTab} infographics={infographics} />
                                <FilterBar selected={selectedCategory} onSelect={setSelectedCategory} />
                                
                                <div className="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {loading ? (
                                        [...Array(6)].map((_, i) => <SkeletonCard key={i} />)
                                    ) : (
                                        filtered.map(p => (
                                            <ProjectCard 
                                                key={p.id} 
                                                project={p} 
                                                onOpen={setViewProject} 
                                                onCopy={(link) => { 
                                                    navigator.clipboard.writeText(link); 
                                                    setToastMsg("คัดลอกลิงก์แล้ว"); 
                                                }} 
                                                onQR={setQrData}
                                                onEdit={handleEditStart}
                                                onDelete={handleDelete}
                                            />
                                        ))
                                    )}
                                </div>
                                
                                {!loading && filtered.length === 0 && (
                                    <div className="text-center py-20 animate-fade-in">
                                        <div className="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
                                            <i className="fa-solid fa-search text-4xl text-gray-300"></i>
                                        </div>
                                        <p className="text-gray-400 text-lg font-medium">ไม่พบข้อมูลที่ค้นหา</p>
                                        <p className="text-gray-400 text-sm mt-2">ลองค้นหาด้วยคำอื่นหรือเปลี่ยนหมวดหมู่</p>
                                    </div>
                                )}
                            </>
                        ) : (
                            <>
                                <div className="px-4 pt-8 pb-4">
                                    <h2 className="text-3xl md:text-4xl font-bold gradient-text mb-2">
                                        คลัง Infographic
                                    </h2>
                                    <p className="text-gray-500 text-sm md:text-base flex items-center gap-2">
                                        <i className="fa-solid fa-palette text-gold"></i>
                                        สื่อการสอนและภาพความรู้
                                    </p>
                                </div>

                                <SearchBox value={searchTerm} onChange={setSearchTerm} />
                                <StatsSection projects={projects} visitors={visitors} activeTab={activeTab} infographics={infographics} />

                                <div className="p-4">
                                    <div className="masonry-grid">
                                        {loading ? (
                                            [...Array(6)].map((_, i) => <InfographicSkeleton key={i} />)
                                        ) : (
                                            filteredInfographics.map(i => (
                                                <InfographicCard
                                                    key={i.id}
                                                    infographic={i}
                                                    onView={setViewInfographic}
                                                    onDownload={handleDownloadInfographic}
                                                    onEdit={handleEditInfographic}
                                                    onDelete={handleDeleteInfographic}
                                                />
                                            ))
                                        )}
                                    </div>
                                </div>
                                
                                {!loading && filteredInfographics.length === 0 && (
                                    <div className="text-center py-20 animate-fade-in">
                                        <div className="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
                                            <i className="fa-solid fa-search text-4xl text-gray-300"></i>
                                        </div>
                                        <p className="text-gray-400 text-lg font-medium">ไม่พบข้อมูลที่ค้นหา</p>
                                        <p className="text-gray-400 text-sm mt-2">ลองค้นหาด้วยคำอื่น</p>
                                    </div>
                                )}
                            </>
                        )}
                    </main>

                    <ProjectFormModal 
                        isOpen={formModalOpen} 
                        onClose={() => setFormModalOpen(false)} 
                        refreshData={fetchProjects} 
                        initialData={editingProject} 
                    />

                    <InfographicFormModal
                        isOpen={infographicFormOpen}
                        onClose={() => setInfographicFormOpen(false)}
                        refreshData={fetchInfographics}
                        initialData={editingInfographic}
                    />
                    
                    {viewProject && (
                        <div className="fixed inset-0 bg-white z-50 overflow-y-auto animate-slide-up">
                            <div className="sticky top-0 glass z-10 px-4 py-4 border-b border-gray-200/50 shadow-sm safe-top">
                                <div className="max-w-3xl mx-auto flex items-center justify-between">
                                    <h2 className="font-bold text-lg md:text-xl text-gray-800 truncate pr-4 flex-1">
                                        {viewProject.title}
                                    </h2>
                                    <button 
                                        onClick={() => setViewProject(null)} 
                                        className="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-xl transition-all active:scale-95 flex-shrink-0"
                                    >
                                        <i className="fa-solid fa-xmark text-xl text-gray-600"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="max-w-3xl mx-auto">
                                <div className="relative bg-gradient-to-br from-gray-100 to-gray-200 overflow-hidden">
                                    <img 
                                        src={viewProject.imageUrl} 
                                        className="w-full h-auto max-h-[60vh] object-contain" 
                                        onError={(e) => e.target.src = 'https://via.placeholder.com/400x300?text=No+Image'} 
                                        alt={viewProject.title}
                                    />
                                </div>
                                
                                <div className="p-6 md:p-8">
                                    <div className="flex items-center gap-3 mb-6">
                                        <span className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 text-accent text-xs font-bold px-4 py-2 rounded-xl shadow-sm">
                                            {viewProject.category}
                                        </span>
                                        <span className="text-gray-400 text-sm flex items-center gap-2">
                                            <i className="fa-regular fa-calendar"></i>
                                            {new Date(viewProject.timestamp).toLocaleDateString('th-TH', { 
                                                year: 'numeric', 
                                                month: 'long', 
                                                day: 'numeric' 
                                            })}
                                        </span>
                                    </div>
                                    
                                    <p className="text-gray-700 leading-relaxed whitespace-pre-line text-base md:text-lg mb-10">
                                        {viewProject.description}
                                    </p>
                                    
                                    <a 
                                        href={viewProject.link} 
                                        target="_blank" 
                                        className="btn-primary ripple block w-full text-white text-center font-bold py-4 rounded-2xl shadow-xl hover:shadow-2xl flex items-center justify-center gap-3"
                                    >
                                        <span>ไปยังลิงก์ผลงานจริง</span>
                                        <i className="fa-solid fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    )}

                    <InfographicViewer
                        infographic={viewInfographic}
                        onClose={() => setViewInfographic(null)}
                        onDownload={handleDownloadInfographic}
                    />
                    
                    {qrData && <QRModal link={qrData.link} title={qrData.title} onClose={() => setQrData(null)} />}
                    {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg(null)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
